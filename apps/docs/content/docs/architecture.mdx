---
title: Architecture
description: System design, data model, and request flow
---

import { Callout } from 'fumadocs-ui/components/callout';
import { Mermaid } from '@/components/mermaid';

## System Overview

PolicyFlow is a **single Go binary** that embeds the compiled Next.js frontend using `go:embed`. There are no external service dependencies — only a local SQLite file.

<Mermaid chart={`
flowchart TB
  subgraph bin["./build/policyflow"]
    direction TB
    echo["Echo HTTP Server\n/api/* routes"]
    spa["Embedded Next.js SPA\ngo:embed web/out/**"]
    router["Request Router\n/api/* → API handlers\n/* → SPA fallback"]
    db["SQLite WAL mode\npolicyflow.db"]

    echo --> router
    spa  --> router
    router --> db
  end
`} />

---

## Role-Based Access Control

PolicyFlow uses three roles with strictly enforced scopes:

| Role | Scope | Capabilities |
|---|---|---|
| **SuperAdmin** | Organization-wide | Manage all users, departments, and policies |
| **DeptAdmin** | Own department only | Manage dept users; create and edit dept-scoped policies |
| **Staff** | Read-only | View accessible policies; record acknowledgements |

<Callout type="info">
  DeptAdmin actions are fully department-scoped and enforced server-side. A DeptAdmin cannot create organization-wide policies, reassign policies to other departments, or manage users outside their own department.
</Callout>

---

## Data Model

```
departments
  id          TEXT  PK
  name        TEXT  UNIQUE
  description TEXT
  created_at  DATETIME
  updated_at  DATETIME

users
  id            TEXT  PK
  email         TEXT  UNIQUE
  name          TEXT
  role          TEXT  SuperAdmin | DeptAdmin | Staff
  department_id TEXT  FK → departments.id  (nullable)
  created_by    TEXT  FK → users.id
  created_at    DATETIME

policies
  id                  TEXT  PK
  title               TEXT
  current_version_id  TEXT  FK → policy_versions.id
  status              TEXT  Draft | Review | Published | Archived
  department_id       TEXT  FK → departments.id  (nullable)
  visibility_type     TEXT  organization | department
  created_at          DATETIME

policy_versions
  id             TEXT  PK
  policy_id      TEXT  FK → policies.id
  content        TEXT  (Markdown)
  version_string TEXT  (e.g. v1.0.0)
  changelog      TEXT
  created_at     DATETIME

acknowledgements
  id                TEXT  PK
  user_id           TEXT  FK → users.id
  policy_version_id TEXT  FK → policy_versions.id
  timestamp         DATETIME
  signature_hash    TEXT  SHA-256(user_id + version_id + timestamp)
  UNIQUE(user_id, policy_version_id)
```

### Policy visibility

- `organization` — visible to all authenticated users regardless of department
- `department` — visible only to users in the same department as the policy

---

## Policy State Machine

<Mermaid chart={`
stateDiagram-v2
  [*] --> Draft
  Draft --> Review     : Admin promotes to Review
  Review --> Published : Admin publishes
  Review --> Draft     : Admin sends back
  Published --> Archived : Admin archives
  Archived --> Draft   : Admin resets to Draft
  Published --> Draft  : Admin demotes
`} />

Transitions are enforced in `PUT /api/policies/:id`. The `status` field accepts: `Draft`, `Review`, `Published`, `Archived`.

SuperAdmin can move any policy through its lifecycle. DeptAdmin can only manage policies within their own department.

---

## Authentication Flow

<Mermaid chart={`
sequenceDiagram
  actor User
  participant Frontend
  participant Backend

  User->>Frontend: Enter work email
  Frontend->>Backend: POST /api/magic-link
  Backend-->>User: Email with magic link (JWT, 24h)

  User->>Backend: GET /api/magic-login?token=…
  Backend->>Backend: Validate JWT signature & expiry
  Backend->>Backend: Build session JWT (sub=user_id, role, 7d)
  Backend-->>Frontend: 302 → /auth-callback?token=session-jwt

  Frontend->>Frontend: Store session JWT in localStorage
  Frontend-->>User: Redirect to /policies
`} />

---

## Monorepo Layout

```
policyflow/
├── Makefile              ← root orchestration
├── build/
│   └── policyflow        ← compiled binary (gitignored)
├── docker/
│   ├── Dockerfile.backend
│   └── docker-compose.yml
├── apps/
│   ├── app/              ← Go + Next.js
│   │   ├── main.go       ← server + embed
│   │   ├── go.mod
│   │   ├── internal/
│   │   │   ├── database/ ← schema + all queries
│   │   │   ├── handlers/ ← auth, users, policies
│   │   │   ├── middleware/← JWT auth guard
│   │   │   ├── email/    ← SMTP mailer
│   │   │   └── seed/     ← initial data
│   │   └── web/          ← Next.js 15 (output: export)
│   │       ├── app/      ← App Router pages
│   │       ├── lib/      ← API client, auth helpers
│   │       └── components/
│   └── docs/             ← Fumadocs site (this site)
└── shared/               ← future: shared types, SQL migrations
```

---

## Future Integration Points

PolicyFlow is designed to be extended:

| Extension | Hook Point |
|---|---|
| **SSO / OIDC** | Replace magic-link handler in `internal/handlers/auth.go` |
| **Employee import** | New `POST /api/users/import` handler reading CSV/SCIM |
| **LDAP sync** | Background goroutine syncing `users` from LDAP directory |
| **Webhooks** | Fire events from acknowledgement/publish handlers |
| **PDF audit log** | Export acknowledgement records as signed PDF |

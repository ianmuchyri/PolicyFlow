---
title: API Reference
description: Complete REST API documentation for PolicyFlow
---

import { Callout } from 'fumadocs-ui/components/callout';

<Callout>
  All authenticated endpoints require an `Authorization: Bearer <token>` header. Obtain a token via the magic-link flow.
</Callout>

## Base URL

```
http://localhost:8080    (development)
https://your-domain.com  (production)
```

---

## Authentication

### POST /api/magic-link

Request a login link. If the email is registered, a link is sent.

**Public — no auth required**

```json
// Request
POST /api/magic-link
Content-Type: application/json

{
  "email": "user@company.com"
}

// Response 200
{
  "message": "if that email is registered, a link has been sent"
}
```

The response is identical whether the email exists or not (to prevent user enumeration).

---

### GET /api/magic-login

Validates a magic link token and issues a session. Called automatically when a user clicks their login link.

**Public — token passed as query param**

```
GET /api/magic-login?token=<jwt>
```

On success, redirects to `/auth-callback?token=<session-jwt>`.

| Response | Description |
|---|---|
| `302` | Redirect to `/auth-callback?token=...` |
| `400` | Missing token |
| `401` | Invalid or expired token |

---

### GET /api/me

Returns the currently authenticated user.

**Auth required**

```json
// Response 200
{
  "id": "uuid",
  "email": "user@company.com",
  "name": "Jane Smith",
  "role": "DeptAdmin",
  "department_id": "uuid",
  "department_name": "Engineering",
  "created_by": "uuid",
  "created_at": "2024-01-15T10:30:00Z"
}
```

`role` is one of `SuperAdmin`, `DeptAdmin`, or `Staff`. `department_id` / `department_name` are `null` for users with no department assignment.

---

## Departments

### GET /api/departments

List all departments.

**Auth required (any role)**

```json
// Response 200
[
  {
    "id": "uuid",
    "name": "Engineering",
    "description": "Engineering team",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
]
```

---

## Policies

### GET /api/policies

List all policies with the current user's acknowledgement status.

**Auth required**

```json
// Response 200
[
  {
    "id": "uuid",
    "title": "Employee Code of Conduct",
    "current_version_id": "uuid",
    "status": "Published",
    "department_id": "uuid",
    "department_name": "Human Resources",
    "visibility_type": "organization",
    "created_at": "2024-01-01T00:00:00Z",
    "acknowledged": false
  }
]
```

Results are filtered by visibility: Staff and DeptAdmin only see organization-wide policies plus their own department's policies. SuperAdmin sees all.

---

### GET /api/policies/:id

Get full policy detail with the current version content.

**Auth required**

```json
// Response 200
{
  "policy": {
    "id": "uuid",
    "title": "Employee Code of Conduct",
    "current_version_id": "uuid",
    "status": "Published",
    "department_id": "uuid",
    "department_name": "Human Resources",
    "visibility_type": "organization",
    "created_at": "2024-01-01T00:00:00Z"
  },
  "current_version": {
    "id": "uuid",
    "policy_id": "uuid",
    "content": "# Employee Code of Conduct\n\n...",
    "version_string": "v1.0.0",
    "changelog": "Initial release",
    "created_at": "2024-01-01T00:00:00Z"
  },
  "acknowledged": false
}
```

| Code | Description |
|---|---|
| `200` | Success |
| `404` | Policy not found |

---

### GET /api/policies/:id/versions

Get full version history for a policy, ordered newest first.

**Auth required**

```json
// Response 200
[
  {
    "id": "uuid",
    "policy_id": "uuid",
    "content": "...",
    "version_string": "v1.1.0",
    "changelog": "Updated section 3",
    "created_at": "2024-03-01T00:00:00Z"
  },
  {
    "id": "uuid",
    "policy_id": "uuid",
    "content": "...",
    "version_string": "v1.0.0",
    "changelog": "Initial release",
    "created_at": "2024-01-01T00:00:00Z"
  }
]
```

---

### POST /api/policies/:id/acknowledge

Record the current user's acknowledgement of the current version.

**Auth required**

```json
// Response 201
{
  "id": "uuid",
  "user_id": "uuid",
  "policy_version_id": "uuid",
  "timestamp": "2024-04-10T14:22:00Z",
  "signature_hash": "sha256hex..."
}
```

| Code | Description |
|---|---|
| `201` | Acknowledgement recorded |
| `400` | Policy not published, or no current version |
| `409` | Already acknowledged this version |

---

## Admin — Users

<Callout type="warn">Requires **DeptAdmin** or **SuperAdmin** role. `PUT` and `DELETE` require **SuperAdmin** only.</Callout>

### GET /api/users

List users. SuperAdmin sees all users; DeptAdmin sees only users in their own department.

```json
// Response 200
[
  {
    "id": "uuid",
    "email": "jane@company.com",
    "name": "Jane Smith",
    "role": "Staff",
    "department_id": "uuid",
    "department_name": "Engineering",
    "created_by": "uuid",
    "created_at": "2024-01-01T00:00:00Z"
  }
]
```

---

### POST /api/users

Create a new user and send them a welcome email with a magic login link.

```json
// Request
{
  "email": "jane@company.com",
  "name": "Jane Smith",
  "role": "Staff",         // "Staff", "DeptAdmin", or "SuperAdmin"
  "department_id": "uuid"  // optional
}

// Response 201
{
  "id": "uuid",
  "email": "jane@company.com",
  "name": "Jane Smith",
  "role": "Staff",
  "department_id": "uuid",
  "department_name": "Engineering",
  "created_by": "uuid",
  "created_at": "2024-04-10T14:00:00Z"
}
```

<Callout type="info">
  When the caller is a DeptAdmin, the new user is automatically assigned to the caller's department and cannot be assigned `SuperAdmin` role.
</Callout>

| Code | Description |
|---|---|
| `201` | User created, welcome email sent |
| `400` | Missing required fields or invalid role |
| `403` | DeptAdmin attempting to create SuperAdmin |
| `409` | Email already registered |

---

### PUT /api/users/:id — SuperAdmin only

Update an existing user's name, email, role, or department assignment.

---

### DELETE /api/users/:id — SuperAdmin only

Delete a user. Cannot delete yourself or the last SuperAdmin.

---

## Admin — Policies

<Callout type="warn">Requires **DeptAdmin** or **SuperAdmin** role. DeptAdmin actions are restricted to their own department's dept-scoped policies.</Callout>

### POST /api/policies

Create a new policy (starts in `Draft` status).

```json
// Request
{
  "title": "Remote Work Policy",
  "visibility_type": "organization",  // "organization" or "department"
  "department_id": "uuid"             // required when visibility_type is "department"
}

// Response 201
{
  "id": "uuid",
  "title": "Remote Work Policy",
  "current_version_id": null,
  "status": "Draft",
  "visibility_type": "organization",
  "department_id": null,
  "department_name": null,
  "created_at": "2024-04-10T00:00:00Z"
}
```

<Callout type="info">
  When the caller is a DeptAdmin, `visibility_type` is automatically set to `"department"` and `department_id` is set to their department — regardless of what the request body specifies.
</Callout>

---

### PUT /api/policies/:id

Update policy title, status, department assignment, or visibility.

```json
// Request (send only fields you want to change)
{
  "status": "Published"
}

// Response 200 — updated policy object
```

Valid status values: `Draft`, `Review`, `Published`, `Archived`

<Callout type="info">
  DeptAdmin can only update policies in their own department. Their updates cannot change `visibility_type` or `department_id`.
</Callout>

---

### POST /api/policies/:id/versions

Add a new version and set it as the current version.

```json
// Request
{
  "content": "# Remote Work Policy\n\n## 1. Eligibility\n...",
  "version_string": "v1.0.0",
  "changelog": "Initial release"
}

// Response 201 — new version object
```

---

## Admin — Departments

<Callout type="warn">Requires **SuperAdmin** role.</Callout>

### POST /api/departments

Create a new department.

```json
// Request
{ "name": "Legal", "description": "Legal & compliance team" }
// Response 201 — department object
```

### PUT /api/departments/:id

Update a department's name or description.

### DELETE /api/departments/:id

Delete a department. Fails if users or policies are still assigned to it.

---

## Admin — Stats

### GET /api/admin/stats

Returns aggregate statistics for the admin dashboard.

```json
// Response 200
{
  "stats": {
    "total_users": 42,
    "total_policies": 8,
    "published_count": 5,
    "draft_count": 2,
    "review_count": 1,
    "archived_count": 0,
    "total_acknowledgements": 186
  },
  "ack_counts": [
    {
      "policy_id": "uuid",
      "title": "Employee Code of Conduct",
      "ack_count": 38
    }
  ]
}
```

---

## Error Responses

All errors follow the Echo default format:

```json
{
  "message": "human-readable error description"
}
```

| Code | Meaning |
|---|---|
| `400` | Bad request — check your payload |
| `401` | Not authenticated — include Bearer token |
| `403` | Forbidden — insufficient role or department scope |
| `404` | Resource not found |
| `409` | Conflict — duplicate (e.g. email already exists, already acknowledged) |
| `500` | Internal server error |

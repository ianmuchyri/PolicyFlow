---
title: API Reference
description: Complete REST API documentation for PolicyFlow
---

import { Callout } from 'fumadocs-ui/components/callout';

<Callout>
  All authenticated endpoints require an `Authorization: Bearer <token>` header. Obtain a token via the magic-link flow.
</Callout>

## Base URL

```
http://localhost:8080    (development)
https://your-domain.com  (production)
```

---

## Authentication

### POST /api/magic-link

Request a login link. If the email is registered, a link is sent.

**Public — no auth required**

```json
// Request
POST /api/magic-link
Content-Type: application/json

{
  "email": "user@company.com"
}

// Response 200
{
  "message": "if that email is registered, a link has been sent"
}
```

The response is identical whether the email exists or not (to prevent user enumeration).

---

### GET /api/magic-login

Validates a magic link token and issues a session. Called automatically when a user clicks their login link.

**Public — token passed as query param**

```
GET /api/magic-login?token=<jwt>
```

On success, redirects to `/auth-callback?token=<session-jwt>`.

| Response | Description |
|---|---|
| `302` | Redirect to `/auth-callback?token=...` |
| `400` | Missing token |
| `401` | Invalid or expired token |

---

### GET /api/me

Returns the currently authenticated user.

**Auth required**

```json
// Response 200
{
  "id": "uuid",
  "email": "user@company.com",
  "name": "Jane Smith",
  "role": "Staff",
  "created_by": "uuid",
  "created_at": "2024-01-15T10:30:00Z"
}
```

---

## Policies

### GET /api/policies

List all policies with the current user's acknowledgement status.

**Auth required**

```json
// Response 200
[
  {
    "id": "uuid",
    "title": "Employee Code of Conduct",
    "current_version_id": "uuid",
    "status": "Published",
    "department": "Human Resources",
    "created_at": "2024-01-01T00:00:00Z",
    "acknowledged": false
  }
]
```

---

### GET /api/policies/:id

Get full policy detail with the current version content.

**Auth required**

```json
// Response 200
{
  "policy": {
    "id": "uuid",
    "title": "Employee Code of Conduct",
    "current_version_id": "uuid",
    "status": "Published",
    "department": "Human Resources",
    "created_at": "2024-01-01T00:00:00Z"
  },
  "current_version": {
    "id": "uuid",
    "policy_id": "uuid",
    "content": "# Employee Code of Conduct\n\n...",
    "version_string": "v1.0.0",
    "changelog": "Initial release",
    "created_at": "2024-01-01T00:00:00Z"
  },
  "acknowledged": false
}
```

| Code | Description |
|---|---|
| `200` | Success |
| `404` | Policy not found |

---

### GET /api/policies/:id/versions

Get full version history for a policy, ordered newest first.

**Auth required**

```json
// Response 200
[
  {
    "id": "uuid",
    "policy_id": "uuid",
    "content": "...",
    "version_string": "v1.1.0",
    "changelog": "Updated section 3",
    "created_at": "2024-03-01T00:00:00Z"
  },
  {
    "id": "uuid",
    "policy_id": "uuid",
    "content": "...",
    "version_string": "v1.0.0",
    "changelog": "Initial release",
    "created_at": "2024-01-01T00:00:00Z"
  }
]
```

---

### POST /api/policies/:id/acknowledge

Record the current user's acknowledgement of the current version.

**Auth required**

```json
// Response 201
{
  "id": "uuid",
  "user_id": "uuid",
  "policy_version_id": "uuid",
  "timestamp": "2024-04-10T14:22:00Z",
  "signature_hash": "sha256hex..."
}
```

| Code | Description |
|---|---|
| `201` | Acknowledgement recorded |
| `400` | Policy not published, or no current version |
| `409` | Already acknowledged this version |

---

## Admin — Users

<Callout type="error">These endpoints require **Admin** role.</Callout>

### GET /api/users

List all users.

```json
// Response 200
[
  {
    "id": "uuid",
    "email": "admin@company.com",
    "name": "Policy Admin",
    "role": "Admin",
    "created_at": "2024-01-01T00:00:00Z"
  }
]
```

---

### POST /api/users

Create a new user and send them a welcome email with a magic login link.

```json
// Request
{
  "email": "jane@company.com",
  "name": "Jane Smith",
  "role": "Staff"   // "Staff" (default) or "Admin"
}

// Response 201
{
  "id": "uuid",
  "email": "jane@company.com",
  "name": "Jane Smith",
  "role": "Staff",
  "created_by": "uuid",
  "created_at": "2024-04-10T14:00:00Z"
}
```

| Code | Description |
|---|---|
| `201` | User created, welcome email sent |
| `400` | Missing required fields or invalid role |
| `409` | Email already registered |

---

## Admin — Policies

<Callout type="error">These endpoints require **Admin** role.</Callout>

### POST /api/policies

Create a new policy (starts in `Draft` status).

```json
// Request
{
  "title": "Remote Work Policy",
  "department": "Operations"
}

// Response 201
{
  "id": "uuid",
  "title": "Remote Work Policy",
  "current_version_id": null,
  "status": "Draft",
  "department": "Operations",
  "created_at": "2024-04-10T00:00:00Z"
}
```

---

### PUT /api/policies/:id

Update policy title, status, or department.

```json
// Request (send only fields you want to change)
{
  "status": "Published"
}

// Response 200 — updated policy object
```

Valid status values: `Draft`, `Review`, `Published`, `Archived`

---

### POST /api/policies/:id/versions

Add a new version and set it as the current version.

```json
// Request
{
  "content": "# Remote Work Policy\n\n## 1. Eligibility\n...",
  "version_string": "v1.0.0",
  "changelog": "Initial release"
}

// Response 201 — new version object
```

---

## Admin — Stats

### GET /api/admin/stats

Returns aggregate statistics for the admin dashboard.

```json
// Response 200
{
  "stats": {
    "total_users": 42,
    "total_policies": 8,
    "published_count": 5,
    "draft_count": 2,
    "review_count": 1,
    "archived_count": 0,
    "total_acknowledgements": 186
  },
  "ack_counts": [
    {
      "policy_id": "uuid",
      "title": "Employee Code of Conduct",
      "ack_count": 38
    }
  ]
}
```

---

## Error Responses

All errors follow the Echo default format:

```json
{
  "message": "human-readable error description"
}
```

| Code | Meaning |
|---|---|
| `400` | Bad request — check your payload |
| `401` | Not authenticated — include Bearer token |
| `403` | Forbidden — Admin role required |
| `404` | Resource not found |
| `409` | Conflict — duplicate (e.g. email already exists, already acknowledged) |
| `500` | Internal server error |
